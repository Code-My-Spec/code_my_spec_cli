#!/bin/bash
# PreToolUse hook: rewrite `mix test` â†’ `mix agent_test`
STDIN_DATA=$(cat)

COMMAND=$(echo "$STDIN_DATA" | jq -r '.tool_input.command // empty' 2>/dev/null)
[ -z "$COMMAND" ] && exit 0

# Match `mix test` but not `mix agent_test`
if echo "$COMMAND" | grep -qE 'mix test( |$)' && ! echo "$COMMAND" | grep -q 'mix agent_test'; then
  REPLACEMENT=$(echo "$COMMAND" | sed 's/mix test/MIX_ENV=test mix agent_test/g')

  jq -n --arg cmd "$REPLACEMENT" '{
    "hookSpecificOutput": {
      "hookEventName": "PreToolUse",
      "permissionDecision": "allow",
      "permissionDecisionReason": "Redirected mix test to mix agent_test",
      "updatedInput": {
        "command": $cmd
      }
    }
  }'
fi
